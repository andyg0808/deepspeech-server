- hosts: localhost
  tasks:
    - name: Add key to authorized_keys on default system
      command: "ssh-copy-id pi@{{hostvars[host].ip}}"
- hosts: "{{host}}"
  vars_files:
    - ./vault.yml
  become: true
  vars:
    ansible_host: "{{ip}}"
    ansible_user: pi
  tasks:
    - name: Set hostname
      hostname: 
        name: "{{inventory_hostname_short}}"
    - name: Add avahi-daemon
      apt:
        update_cache: yes
        name: avahi-daemon
    - name: Install docker
      apt:
        name: docker.io
    - name: Add docker group
      group:
        name: docker
    - name: Add pi user to docker group
      user:
        name: pi
        groups: docker
    - name: Expose system via zeroconf
      lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: publish-workstation
        line: publish-workstation=yes
    - name: Reload avahi-daemon
      service:
        name: avahi-daemon.service
        state: restarted
    - name: Set standard password for user
      user:
        name: pi
        password: "{{password | password_hash('sha256')}}"
    - name: Lock user account
      command: passwd -l pi
    - name: Install network-manager
      apt:
        name: network-manager
